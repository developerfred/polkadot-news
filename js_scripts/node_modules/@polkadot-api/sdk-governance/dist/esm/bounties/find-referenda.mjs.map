{"version":3,"file":"find-referenda.mjs","sources":["../../../src/bounties/find-referenda.ts"],"sourcesContent":["import { OngoingReferendum } from \"@/referenda/sdk-types\"\nimport { keyedMemo } from \"@/util/memo\"\nimport { MultiAddress } from \"./descriptors\"\n\nconst spenderOrigins = [\n  \"Treasurer\",\n  \"SmallSpender\",\n  \"MediumSpender\",\n  \"BigSpender\",\n  \"SmallTipper\",\n  \"BigTipper\",\n]\n\nconst getDecodedSpenderReferenda = keyedMemo(\n  async (ongoingReferenda: OngoingReferendum[]) => {\n    const spenderReferenda = ongoingReferenda.filter(\n      (ref) =>\n        (ref.origin.type === \"Origins\" &&\n          spenderOrigins.includes(ref.origin.value.type)) ||\n        (ref.origin.type === \"system\" && ref.origin.value.type === \"Root\"),\n    )\n    const response = await Promise.all(\n      spenderReferenda.map((referendum) =>\n        referendum.proposal\n          .decodedCall()\n          .then((call) => ({\n            referendum,\n            call,\n          }))\n          .catch((ex) => {\n            console.error(ex)\n            return null\n          }),\n      ),\n    )\n    return response.filter((v) => !!v)\n  },\n  new WeakMap(),\n)\n\nexport async function findApprovingReferenda(\n  ongoingReferenda: OngoingReferendum[],\n  bountyId: number,\n) {\n  const spenderReferenda = await getDecodedSpenderReferenda(ongoingReferenda)\n\n  return spenderReferenda\n    .filter(({ call }) =>\n      findCalls(\n        {\n          pallet: \"Bounties\",\n          name: \"approve_bounty\",\n        },\n        call,\n      ).some((v) => v?.bounty_id === bountyId),\n    )\n    .map(({ referendum }) => referendum)\n}\n\nexport async function findProposingCuratorReferenda(\n  ongoingReferenda: OngoingReferendum[],\n  bountyId: number,\n) {\n  const spenderReferenda = await getDecodedSpenderReferenda(ongoingReferenda)\n\n  return spenderReferenda\n    .map(({ call, referendum }) => {\n      const proposeCuratorCalls = findCalls(\n        {\n          pallet: \"Bounties\",\n          name: \"propose_curator\",\n        },\n        call,\n      )\n        .filter(\n          (v) =>\n            v?.bounty_id === bountyId &&\n            typeof v.curator === \"object\" &&\n            typeof v.fee === \"bigint\",\n        )\n        .map((v) => ({\n          curator: v.curator as MultiAddress,\n          fee: v.fee as bigint,\n        }))\n      if (!proposeCuratorCalls.length) return null\n      return { referendum, proposeCuratorCalls }\n    })\n    .filter((v) => v !== null)\n}\n\nexport const findCalls = (\n  call: { pallet: string; name: string },\n  obj: any,\n): any[] => {\n  if (typeof obj !== \"object\") return []\n  if (Array.isArray(obj)) {\n    const approves = []\n    for (const item of obj) approves.push(...findCalls(call, item))\n    return approves\n  }\n  if (obj?.type === call.pallet && obj?.value?.type === call.name) {\n    return [obj.value.value]\n  }\n  const approves = []\n  for (const key of Object.keys(obj))\n    approves.push(...findCalls(call, obj[key]))\n  return approves\n}\n"],"names":["approves"],"mappings":";;AAIA,MAAM,cAAiB,GAAA;AAAA,EACrB,WAAA;AAAA,EACA,cAAA;AAAA,EACA,eAAA;AAAA,EACA,YAAA;AAAA,EACA,aAAA;AAAA,EACA;AACF,CAAA;AAEA,MAAM,0BAA6B,GAAA,SAAA;AAAA,EACjC,OAAO,gBAA0C,KAAA;AAC/C,IAAA,MAAM,mBAAmB,gBAAiB,CAAA,MAAA;AAAA,MACxC,CAAC,QACE,GAAI,CAAA,MAAA,CAAO,SAAS,SACnB,IAAA,cAAA,CAAe,SAAS,GAAI,CAAA,MAAA,CAAO,MAAM,IAAI,CAAA,IAC9C,IAAI,MAAO,CAAA,IAAA,KAAS,YAAY,GAAI,CAAA,MAAA,CAAO,MAAM,IAAS,KAAA;AAAA,KAC/D;AACA,IAAM,MAAA,QAAA,GAAW,MAAM,OAAQ,CAAA,GAAA;AAAA,MAC7B,gBAAiB,CAAA,GAAA;AAAA,QAAI,CAAC,eACpB,UAAW,CAAA,QAAA,CACR,aACA,CAAA,IAAA,CAAK,CAAC,IAAU,MAAA;AAAA,UACf,UAAA;AAAA,UACA;AAAA,SACA,CAAA,CAAA,CACD,KAAM,CAAA,CAAC,EAAO,KAAA;AACb,UAAA,OAAA,CAAQ,MAAM,EAAE,CAAA;AAChB,UAAO,OAAA,IAAA;AAAA,SACR;AAAA;AACL,KACF;AACA,IAAA,OAAO,SAAS,MAAO,CAAA,CAAC,CAAM,KAAA,CAAC,CAAC,CAAC,CAAA;AAAA,GACnC;AAAA,sBACI,OAAQ;AACd,CAAA;AAEsB,eAAA,sBAAA,CACpB,kBACA,QACA,EAAA;AACA,EAAM,MAAA,gBAAA,GAAmB,MAAM,0BAAA,CAA2B,gBAAgB,CAAA;AAE1E,EAAA,OAAO,gBACJ,CAAA,MAAA;AAAA,IAAO,CAAC,EAAE,IAAA,EACT,KAAA,SAAA;AAAA,MACE;AAAA,QACE,MAAQ,EAAA,UAAA;AAAA,QACR,IAAM,EAAA;AAAA,OACR;AAAA,MACA;AAAA,MACA,IAAK,CAAA,CAAC,CAAM,KAAA,CAAA,EAAG,cAAc,QAAQ;AAAA,IAExC,GAAI,CAAA,CAAC,EAAE,UAAA,OAAiB,UAAU,CAAA;AACvC;AAEsB,eAAA,6BAAA,CACpB,kBACA,QACA,EAAA;AACA,EAAM,MAAA,gBAAA,GAAmB,MAAM,0BAAA,CAA2B,gBAAgB,CAAA;AAE1E,EAAA,OAAO,iBACJ,GAAI,CAAA,CAAC,EAAE,IAAA,EAAM,YAAiB,KAAA;AAC7B,IAAA,MAAM,mBAAsB,GAAA,SAAA;AAAA,MAC1B;AAAA,QACE,MAAQ,EAAA,UAAA;AAAA,QACR,IAAM,EAAA;AAAA,OACR;AAAA,MACA;AAAA,KAEC,CAAA,MAAA;AAAA,MACC,CAAC,CACC,KAAA,CAAA,EAAG,SAAc,KAAA,QAAA,IACjB,OAAO,CAAA,CAAE,OAAY,KAAA,QAAA,IACrB,OAAO,CAAA,CAAE,GAAQ,KAAA;AAAA,KACrB,CACC,GAAI,CAAA,CAAC,CAAO,MAAA;AAAA,MACX,SAAS,CAAE,CAAA,OAAA;AAAA,MACX,KAAK,CAAE,CAAA;AAAA,KACP,CAAA,CAAA;AACJ,IAAI,IAAA,CAAC,mBAAoB,CAAA,MAAA,EAAe,OAAA,IAAA;AACxC,IAAO,OAAA,EAAE,YAAY,mBAAoB,EAAA;AAAA,GAC1C,CACA,CAAA,MAAA,CAAO,CAAC,CAAA,KAAM,MAAM,IAAI,CAAA;AAC7B;AAEa,MAAA,SAAA,GAAY,CACvB,IAAA,EACA,GACU,KAAA;AACV,EAAA,IAAI,OAAO,GAAA,KAAQ,QAAU,EAAA,OAAO,EAAC;AACrC,EAAI,IAAA,KAAA,CAAM,OAAQ,CAAA,GAAG,CAAG,EAAA;AACtB,IAAA,MAAMA,YAAW,EAAC;AAClB,IAAW,KAAA,MAAA,IAAA,IAAQ,KAAKA,SAAAA,CAAS,KAAK,GAAG,SAAA,CAAU,IAAM,EAAA,IAAI,CAAC,CAAA;AAC9D,IAAOA,OAAAA,SAAAA;AAAA;AAET,EAAI,IAAA,GAAA,EAAK,SAAS,IAAK,CAAA,MAAA,IAAU,KAAK,KAAO,EAAA,IAAA,KAAS,KAAK,IAAM,EAAA;AAC/D,IAAO,OAAA,CAAC,GAAI,CAAA,KAAA,CAAM,KAAK,CAAA;AAAA;AAEzB,EAAA,MAAM,WAAW,EAAC;AAClB,EAAW,KAAA,MAAA,GAAA,IAAO,MAAO,CAAA,IAAA,CAAK,GAAG,CAAA;AAC/B,IAAA,QAAA,CAAS,KAAK,GAAG,SAAA,CAAU,MAAM,GAAI,CAAA,GAAG,CAAC,CAAC,CAAA;AAC5C,EAAO,OAAA,QAAA;AACT;;;;"}