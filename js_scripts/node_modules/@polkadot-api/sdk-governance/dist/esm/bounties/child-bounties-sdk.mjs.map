{"version":3,"file":"child-bounties-sdk.mjs","sources":["../../../src/bounties/child-bounties-sdk.ts"],"sourcesContent":["import { keyedMemo } from \"@/util/memo\"\nimport { partitionEntries } from \"@/util/watchEntries\"\nimport { combineKeys, toKeySet } from \"@react-rxjs/utils\"\nimport { combineLatest, distinctUntilChanged, map } from \"rxjs\"\nimport { getChildBountyAccount } from \"./bounty-account\"\nimport { getBountyDescriptions$ } from \"./bounty-descriptions\"\nimport {\n  ChildBountiesSdkTypedApi,\n  ChildBountyWithoutDescription,\n} from \"./child-descriptors\"\nimport {\n  ChildBountiesSdk,\n  ChildBounty,\n  GenericChildBounty,\n} from \"./child-sdk-types\"\n\nexport function createChildBountiesSdk(\n  typedApi: ChildBountiesSdkTypedApi,\n): ChildBountiesSdk {\n  const enhanceBounty = (\n    bounty: ChildBountyWithoutDescription,\n    description: string | null,\n    id: number,\n  ): ChildBounty => {\n    const generic: GenericChildBounty = {\n      ...bounty,\n      type: bounty.status.type,\n      id,\n      description,\n      account: getChildBountyAccount(bounty.parent_bounty, id),\n    }\n\n    const idObj = {\n      parent_bounty_id: bounty.parent_bounty,\n      child_bounty_id: id,\n    }\n    switch (generic.status.type) {\n      case \"Added\":\n        return {\n          ...generic,\n          type: \"Added\",\n          proposeCurator(curator, fee) {\n            return typedApi.tx.ChildBounties.propose_curator({\n              ...idObj,\n              curator: {\n                type: \"Id\",\n                value: curator,\n              },\n              fee,\n            })\n          },\n          close() {\n            return typedApi.tx.ChildBounties.close_child_bounty(idObj)\n          },\n        }\n      case \"CuratorProposed\":\n        return {\n          ...generic,\n          ...generic.status.value,\n          type: \"CuratorProposed\",\n          acceptCuratorRole() {\n            return typedApi.tx.ChildBounties.accept_curator(idObj)\n          },\n          unassignCurator() {\n            return typedApi.tx.ChildBounties.unassign_curator(idObj)\n          },\n          close() {\n            return typedApi.tx.ChildBounties.close_child_bounty(idObj)\n          },\n        }\n      case \"Active\":\n        return {\n          ...generic,\n          type: \"Active\",\n          curator: generic.status.value.curator,\n          award(beneficiary) {\n            return typedApi.tx.ChildBounties.award_child_bounty({\n              ...idObj,\n              beneficiary: {\n                type: \"Id\",\n                value: beneficiary,\n              },\n            })\n          },\n          unassignCurator() {\n            return typedApi.tx.ChildBounties.unassign_curator(idObj)\n          },\n          close() {\n            return typedApi.tx.ChildBounties.close_child_bounty(idObj)\n          },\n        }\n      case \"PendingPayout\":\n        return {\n          ...generic,\n          type: \"PendingPayout\",\n          curator: generic.status.value.curator,\n          unlockAt: generic.status.value.unlock_at,\n          beneficiary: generic.status.value.beneficiary,\n          claim() {\n            return typedApi.tx.ChildBounties.claim_child_bounty(idObj)\n          },\n          unassignCurator() {\n            return typedApi.tx.ChildBounties.unassign_curator(idObj)\n          },\n        }\n    }\n    throw new Error(\"Unreachable\")\n  }\n\n  function watchChildBounties(parentId: number) {\n    const [getBountyById$, bountyKeyChanges$] = partitionEntries(\n      typedApi.query.ChildBounties.ChildBounties.watchEntries(parentId),\n    )\n    const descriptions$ = getBountyDescriptions$(\n      typedApi.query.ChildBounties.ChildBountyDescriptions.getEntries,\n      typedApi.query.ChildBounties.ChildBountyDescriptions.getValues,\n      bountyKeyChanges$,\n    )\n\n    const bountyIds$ = bountyKeyChanges$.pipe(\n      toKeySet(),\n      map((set) => [...set]),\n    )\n\n    const getEnhancedBountyById$ = (id: number) =>\n      combineLatest([\n        getBountyById$(id),\n        descriptions$.pipe(\n          map((r): string | null => r[id] ?? null),\n          distinctUntilChanged(),\n        ),\n      ]).pipe(\n        map(([bounty, description]) => enhanceBounty(bounty, description, id)),\n      )\n\n    return {\n      bounties$: combineKeys(bountyIds$, getEnhancedBountyById$),\n      getBountyById$: getEnhancedBountyById$,\n      bountyIds$,\n    }\n  }\n\n  function getChildBounty(parentId: number, id: number) {\n    return Promise.all([\n      typedApi.query.ChildBounties.ChildBounties.getValue(parentId, id),\n      typedApi.query.ChildBounties.ChildBountyDescriptions.getValue(id).then(\n        (r) => (r ? r.asText() : null),\n      ),\n    ]).then(([bounty, description]) =>\n      bounty ? enhanceBounty(bounty, description, id) : null,\n    )\n  }\n\n  return {\n    watch: keyedMemo(watchChildBounties, new Map()),\n    getChildBounty,\n  }\n}\n"],"names":[],"mappings":"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"}