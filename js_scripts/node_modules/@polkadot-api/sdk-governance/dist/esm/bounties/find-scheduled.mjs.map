{"version":3,"file":"find-scheduled.mjs","sources":["../../../src/bounties/find-scheduled.ts"],"sourcesContent":["import { getPreimageResolver } from \"@/preimages\"\nimport { memo } from \"@/util/memo\"\nimport { BountiesSdkTypedApi, MultiAddress } from \"./descriptors\"\nimport { findCalls } from \"./find-referenda\"\n\nexport const scheduledFinder = (typedApi: BountiesSdkTypedApi) => {\n  const resolvePreimage = getPreimageResolver(\n    typedApi.query.Preimage.PreimageFor.getValues,\n  )\n\n  const getScheduledCalls = memo(async () => {\n    const agenda = await typedApi.query.Scheduler.Agenda.getEntries()\n    const token = await typedApi.compatibilityToken\n\n    const scheduled = agenda.flatMap(\n      ({ keyArgs: [height], value: values }) =>\n        values\n          ?.filter((v) => !!v)\n          .map((value) => ({\n            height,\n            call: value.call,\n          })) ?? [],\n    )\n\n    const resolvedCalls = await Promise.all(\n      scheduled.map(({ height, call }) =>\n        resolvePreimage(call)\n          .then(\n            (callData) => typedApi.txFromCallData(callData, token).decodedCall,\n          )\n          .then((decodedCall) => ({ height, call: decodedCall }))\n          .catch((ex) => {\n            console.error(ex)\n            return null\n          }),\n      ),\n    )\n    return resolvedCalls.filter((v) => !!v)\n  })\n  async function findScheduledApproved(bountyId: number) {\n    const calls = await getScheduledCalls()\n\n    return calls\n      .filter(({ call }) =>\n        findCalls({ pallet: \"Bounties\", name: \"approve_bounty\" }, call).some(\n          (v) => v?.bounty_id === bountyId,\n        ),\n      )\n      .map(({ height }) => height)\n  }\n\n  async function findScheduledCuratorProposed(bountyId: number) {\n    const calls = await getScheduledCalls()\n\n    return calls\n      .map(({ call, height }) => {\n        const proposeCuratorCalls = findCalls(\n          {\n            pallet: \"Bounties\",\n            name: \"propose_curator\",\n          },\n          call,\n        )\n          .filter(\n            (v) =>\n              v?.bounty_id === bountyId &&\n              typeof v.curator === \"object\" &&\n              typeof v.fee === \"bigint\",\n          )\n          .map((v) => ({\n            curator: v.curator as MultiAddress,\n            fee: v.fee as bigint,\n          }))\n        if (!proposeCuratorCalls.length) return null\n        return { height, proposeCuratorCalls }\n      })\n      .filter((v) => v !== null)\n  }\n\n  return { findScheduledApproved, findScheduledCuratorProposed }\n}\n"],"names":[],"mappings":"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"}